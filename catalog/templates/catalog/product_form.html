{% extends 'catalog/base.html' %}
{% block content %}
<div class="container mt-5">
  <h2>{% if object %}Редактирай обява{% else %}Нова обява{% endif %}</h2>
  
  {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <strong>Моля, коригирайте следните грешки:</strong>
      <ul class="mb-0 mt-2">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ field }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endif %}
  
  <form method="post" enctype="multipart/form-data">{% csrf_token %}
    <div class="row">
      <div class="col-md-8">
        <!-- Основни полета (без category, city, seller_type, sells_to и is_active) -->
        {% for field in form %}
          {% if field.name not in 'city,category,image,seller_type,sells_to,is_active' %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {% if field.widget.input_type == 'textarea' %}
                <textarea name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-control {% if field.errors %}is-invalid{% endif %}" rows="4" maxlength="500">{{ field.value|default:'' }}</textarea>
                <small class="text-muted">Максимум 500 символа</small>
              {% else %}
                <div class="{% if field.errors %}has-error{% endif %}">
                  {{ field }}
                </div>
              {% endif %}
              {% if field.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in field.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- Категория и подкатегория -->
        <div class="mb-3">
          <label for="category-select" class="form-label">Категория</label>
          <select id="category-select" class="form-select {% if form.category.errors %}is-invalid{% endif %}" required>
            <option value="">Избери категория</option>
            {% for cat in parent_categories %}
              <option value="{{ cat.id }}" 
                {% if object and object.category.parent and object.category.parent.id == cat.id %}selected
                {% elif object and not object.category.parent and object.category.id == cat.id %}selected
                {% endif %}>
                {{ cat.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="subcategory-select" class="form-label">Подкатегория</label>
          <select id="subcategory-select" name="category" class="form-select {% if form.category.errors %}is-invalid{% endif %}" required>
            <option value="">Избери подкатегория</option>
          </select>
          {% if form.category.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.category.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- Регион и град -->
        <div class="mb-3">
          <label for="region-select" class="form-label">Област</label>
          <select id="region-select" name="region" class="form-select">
            <option value="">Избери област</option>
            {% for region in regions %}
              <option value="{{ region.id }}" {% if object.city.region.id == region.id %}selected{% endif %}>{{ region.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="city-select" class="form-label">Населено място</label>
          <select id="city-select" name="city" class="form-select {% if form.city.errors %}is-invalid{% endif %}">
            <option value="">Избери населено място</option>
            {% if form.city.value %}
              {% for city in form.fields.city.queryset %}
                <option value="{{ city.id }}" {% if form.city.value|stringformat:"s" == city.id|stringformat:"s" %}selected{% endif %}>{{ city.name }}</option>
              {% endfor %}
            {% endif %}
          </select>
          {% if form.city.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.city.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- Тип продавач -->
        <div class="mb-3">
          <label for="id_seller_type" class="form-label fw-bold">{{ form.seller_type.label }}</label>
          {{ form.seller_type }}
          {% if form.seller_type.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.seller_type.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
          {% if form.seller_type.help_text %}
            <small class="text-muted d-block mt-1">{{ form.seller_type.help_text }}</small>
          {% endif %}
        </div>

        <!-- Продава на -->
        <div class="mb-4 p-4 border rounded sells-to-section {% if form.sells_to.errors %}border-danger{% endif %}">
          <label class="form-label fw-bold mb-3 d-block">{{ form.sells_to.label }}</label>
          <div class="d-flex flex-row gap-4 flex-wrap">
            {% for checkbox in form.sells_to %}
              <div class="form-check">
                {{ checkbox.tag }}
                <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                  {{ checkbox.choice_label }}
                </label>
              </div>
            {% endfor %}
          </div>
          {% if form.sells_to.help_text %}
            <small class="d-block mt-3" style="opacity: 0.7;">{{ form.sells_to.help_text }}</small>
          {% endif %}
          {% if form.sells_to.errors %}
            <div class="text-danger mt-2">
              {% for error in form.sells_to.errors %}
                {{ error }}
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <style>
          .sells-to-section {
            background-color: rgba(0, 0, 0, 0.05);
          }
          [data-theme="dark"] .sells-to-section {
            background-color: rgba(255, 255, 255, 0.05);
          }
          [data-theme="dark"] .sells-to-section .form-check-label {
            color: #e9ecef;
          }
          [data-theme="dark"] .sells-to-section .form-check-input {
            background-color: #495057;
            border-color: #6c757d;
          }
          [data-theme="dark"] .sells-to-section .form-check-input:checked {
            background-color: #0dd843;
            border-color: #0dd843;
          }
          
          /* Автоматично оцветяване на полета с грешки */
          .has-error .form-control,
          .has-error .form-select {
            border-color: #dc3545 !important;
          }
          
          .invalid-feedback {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
          }
        </style>

        <!-- Активна обява -->
        <div class="mb-5 p-4 border rounded" style="background-color: #e7f5e9; border-color: #0dd843 !important;">
          <div class="form-check">
            <input type="checkbox" name="is_active" id="id_is_active" class="form-check-input" {% if form.is_active.value or not object %}checked{% endif %} />
            <label class="form-check-label fw-bold" for="id_is_active">{{ form.is_active.label }}</label>
          </div>
          <small class="text-muted d-block mt-2">Маркирайте, ако искате обявата да бъде активна и видима</small>
        </div>

        <!-- Снимки -->
        <div class="mb-4">
          <label class="form-label fw-bold">Снимки на продукта (до 5 броя)</label>
          
          <div class="mb-2">
            <label for="image1" class="form-label">Снимка 1 {% if current_images.image1 %}<small class="text-success">(Текуща: {{ current_images.image1.image.name|slice:"9:" }})</small>{% endif %}</label>
            <div class="custom-file-wrapper">
              <input type="file" name="image1" id="image1" accept="image/*" class="form-control custom-file-input" />
              <label class="custom-file-label" for="image1">{% if current_images.image1 %}{{ current_images.image1.image.name|slice:"9:" }}{% else %}Избери файл{% endif %}</label>
            </div>
          </div>
          
          <div class="mb-2">
            <label for="image2" class="form-label">Снимка 2 {% if current_images.image2 %}<small class="text-success">(Текуща: {{ current_images.image2.image.name|slice:"9:" }})</small>{% endif %}</label>
            <div class="custom-file-wrapper">
              <input type="file" name="image2" id="image2" accept="image/*" class="form-control custom-file-input" />
              <label class="custom-file-label" for="image2">{% if current_images.image2 %}{{ current_images.image2.image.name|slice:"9:" }}{% else %}Избери файл{% endif %}</label>
            </div>
          </div>
          
          <div class="mb-2">
            <label for="image3" class="form-label">Снимка 3 {% if current_images.image3 %}<small class="text-success">(Текуща: {{ current_images.image3.image.name|slice:"9:" }})</small>{% endif %}</label>
            <div class="custom-file-wrapper">
              <input type="file" name="image3" id="image3" accept="image/*" class="form-control custom-file-input" />
              <label class="custom-file-label" for="image3">{% if current_images.image3 %}{{ current_images.image3.image.name|slice:"9:" }}{% else %}Избери файл{% endif %}</label>
            </div>
          </div>
          
          <div class="mb-2">
            <label for="image4" class="form-label">Снимка 4 {% if current_images.image4 %}<small class="text-success">(Текуща: {{ current_images.image4.image.name|slice:"9:" }})</small>{% endif %}</label>
            <div class="custom-file-wrapper">
              <input type="file" name="image4" id="image4" accept="image/*" class="form-control custom-file-input" />
              <label class="custom-file-label" for="image4">{% if current_images.image4 %}{{ current_images.image4.image.name|slice:"9:" }}{% else %}Избери файл{% endif %}</label>
            </div>
          </div>
          
          <div class="mb-2">
            <label for="image5" class="form-label">Снимка 5 {% if current_images.image5 %}<small class="text-success">(Текуща: {{ current_images.image5.image.name|slice:"9:" }})</small>{% endif %}</label>
            <div class="custom-file-wrapper">
              <input type="file" name="image5" id="image5" accept="image/*" class="form-control custom-file-input" />
              <label class="custom-file-label" for="image5">{% if current_images.image5 %}{{ current_images.image5.image.name|slice:"9:" }}{% else %}Избери файл{% endif %}</label>
            </div>
          </div>
          
          <small class="text-muted">Можеш да качиш от 1 до 5 снимки{% if object %} (ако не избереш нови снимки, текущите ще останат){% endif %}</small>
        </div>

        <button class="btn btn-success" type="submit">Запази</button>
        <a href="{% url 'catalog:product_list' %}" class="btn btn-secondary">Отмени</a>
      </div>
    </div>
  </form>
</div>

<script>
  (function(){
    const categorySelect = document.getElementById('category-select');
    const subcategorySelect = document.getElementById('subcategory-select');
    const regionSelect = document.getElementById('region-select');
    const citySelect = document.getElementById('city-select');
    const apiSubcategoriesUrl = '{% url "catalog:api_subcategories" %}';
    const apiCitiesUrl = '{% url "catalog:api_cities" %}';

    const currentCategoryId = '{{ object.category.id|default:"" }}';
    const currentCityId = '{{ object.city.id|default:"" }}';

    // Зареждане на подкатегории при смяна на категория
    categorySelect.addEventListener('change', function(){
      const categoryId = this.value;
      subcategorySelect.innerHTML = '<option value="">Избери подкатегория</option>';
      if(!categoryId) return;
      fetch(apiSubcategoriesUrl + '?category=' + categoryId)
        .then(res => res.json())
        .then(data => {
          data.forEach(sc => {
            const opt = document.createElement('option');
            opt.value = sc.id;
            opt.textContent = sc.name;
            if(sc.id == currentCategoryId) {
              opt.selected = true;
            }
            subcategorySelect.appendChild(opt);
          });
        }).catch(err => console.error(err));
    });

    // Зареждане на градове при смяна на регион
    regionSelect.addEventListener('change', function(){
      const regionId = this.value;
      citySelect.innerHTML = '<option value="">Избери населено място</option>';
      if(!regionId) return;
      fetch(apiCitiesUrl + '?region=' + regionId)
        .then(res => res.json())
        .then(data => {
          data.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            if(c.id == currentCityId) {
              opt.selected = true;
            }
            citySelect.appendChild(opt);
          });
        }).catch(err => console.error(err));
    });

    // Автоматично зареждане при зареждане на страница
    if(categorySelect.value) {
      categorySelect.dispatchEvent(new Event('change'));
    }
    if(regionSelect.value) {
      regionSelect.dispatchEvent(new Event('change'));
    }

    // Актуализиране на file input labels
    document.querySelectorAll('.custom-file-input').forEach(input => {
      input.addEventListener('change', function() {
        const label = this.nextElementSibling;
        const fileName = this.files[0] ? this.files[0].name : 'Избери файл';
        label.textContent = fileName;
      });
    });
  })();
</script>

<style>
  .form-select, .form-control { border-color: #0dd843; }
  .form-select:focus, .form-control:focus { border-color: #0dd843; box-shadow: 0 0 0 0.2rem rgba(13, 216, 67, 0.25); }
  
  .custom-file-wrapper { position: relative; }
  .custom-file-input {
    opacity: 0;
    position: absolute;
    z-index: -1;
  }
  .custom-file-label {
    display: block;
    padding: 0.375rem 0.75rem;
    border: 1px solid #0dd843;
    border-radius: 0.25rem;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.3s;
  }
  .custom-file-label:hover {
    background-color: #0dd843;
    color: white;
  }
</style>
{% endblock %}